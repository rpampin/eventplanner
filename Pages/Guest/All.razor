@page "/event/{EventId}/guests"
@using EventPlanner.Models
@using EventPlanner.Models.ModelView
@using EventPlanner.Data
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@inject EventService EventService
@inject GuestService GuestService
@inject NavigationManager NavigationManager
@inject EmailService EmailService
@inject AppState AppState
<Loading IsLoading="AppState.IsLoading" />

<div class="title-action">
    <MudText Typo="Typo.h2">Guests</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Transparent" StartIcon="@Icons.Material.Filled.KeyboardArrowLeft" OnClick="Back" Class="ml-auto">Back to Event</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="New" Class="ml-2">New Guest</MudButton>
</div>

@if (Guests is null || Event is null)
{
    <Loading IsLoading="true" />
}
else
{
    <MudCard>
        <MudCardHeader>
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h4">Event</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudTextField Label="Event Type" Variant="Variant.Outlined" @bind-Value="Event.Type" ReadOnly="true" />
                </MudItem>
                <MudItem xs="4">
                    <MudTextField Label="Event Date" Variant="Variant.Outlined" @bind-Value="Event.Date" ReadOnly="true" />
                </MudItem>
                <MudItem xs="4">
                    <MudTextField Label="Event Celebrants" Variant="Variant.Outlined" @bind-Value="Event.Celebrants" ReadOnly="true" />
                </MudItem>
            </MudGrid>
        </MudCardHeader>
        <MudCardContent>
            <MudText Typo="Typo.h4">Guests</MudText>
            <MudTable Items="@Guests" OnRowClick="Edit" T="Models.Guest" Hover="true" Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>Last Name</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Email</MudTh>
                    <MudTh>Moblie</MudTh>
                    <MudTh>Attendance</MudTh>
                    <MudTh>Table</MudTh>
                    <MudTh>Remarks</MudTh>
                    <MudTh></MudTh>
                    <MudTh></MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="LastName">@context.LastName</MudTd>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Email">@context.Email</MudTd>
                    <MudTd DataLabel="Mobile">@context.Mobile</MudTd>
                    <MudTd DataLabel="WillAttend">@(context.WillAttend.HasValue ? context.WillAttend.Value ? "Attending" : "NOT Attending" : "N/A")</MudTd>
                    <MudTd DataLabel="Table">@context.Table</MudTd>
                    <MudTd DataLabel="Remarks">@context.Remarks</MudTd>
                    <MudTd DataLabel="SendInvite" class="fit">
                        @if (!context.InvitationSent)
                        {
                            <MudTooltip Text="Send invitation">
                                <MudIconButton Icon="@Icons.Material.Filled.Mail" Color="Color.Success" Size="Size.Small" Class="ma-2" @onclick="@(e => SendInvitation(@context))"></MudIconButton>
                            </MudTooltip>
                        }
                    </MudTd>
                    <MudTd DataLabel="SendInvite" class="fit">
                        <MudTooltip Text="Resend invitation">
                            <MudIconButton Icon="@Icons.Material.Filled.MarkEmailRead" Color="Color.Primary" Size="Size.Small" Class="ma-2" @onclick="@(e => ResendInvitation(@context))"></MudIconButton>
                        </MudTooltip>
                    </MudTd>
                    <MudTd DataLabel="Delete" class="fit">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" Class="ma-2" @onclick="@(e => Delete(@context))"></MudIconButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudCardContent>
    </MudCard>
}

@code {
    [Parameter]
    public string EventId { get; set; }
    EventDataView Event = null;
    IEnumerable<Models.Guest> Guests;

    protected override async Task OnInitializedAsync()
    {
        Event = await Task.Run(() => EventService.GetOneData(Guid.Parse(EventId)));
        Guests = await Task.Run(() => GuestService.GetAll(Guid.Parse(EventId)));
    }

    async Task Delete(Models.Guest Guest)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure?");
        if (confirmed)
        {
            await AppState.RunAsync(async () =>
            {
                await GuestService.DeleteOne(Guest);
                NavigationManager.NavigateTo($"/event/{EventId}/guests", true);
            });
        }
    }

    async Task SendInvitation(Models.Guest Guest)
    {
        await AppState.RunAsync(async () =>
        {
            try
            {
                await EmailService.SendInvitations(Guid.Parse(EventId), false, Guest.Id);
            }
            catch (Exception ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        });
    }

    async Task ResendInvitation(Models.Guest Guest)
        => await AppState.RunAsync(async () =>
        {
            try
            {
                await EmailService.SendInvitations(Guid.Parse(EventId), true, Guest.Id);
            }
            catch (Exception ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        });

    protected void Back()
        => NavigationManager.NavigateTo($"/event/{EventId}", true);

    protected void New()
        => NavigationManager.NavigateTo($"/event/{EventId}/guest", true);

    private void Edit(TableRowClickEventArgs<Models.Guest> args)
        => NavigationManager.NavigateTo($"/event/{EventId}/guest/{args.Item.Id}", true);
    }
